<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>个人首页</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="index.co" />
	<meta name="keywords" content="self index" />


	<link href="https://fonts.googleapis.com/css?family=Space+Mono" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet">
	
	<!-- Animate.css -->
	<link rel="stylesheet" th:href="@{../css/animate.css}">
	<!-- Icomoon Icon Fonts-->
	<link rel="stylesheet" th:href="@{../css/icomoon.css}">
	<!-- Bootstrap  -->
	<link rel="stylesheet" th:href="@{../css/bootstrap.css}">

	<!-- Theme style  -->
	<link rel="stylesheet" th:href="@{../css/style.css}">

	<!-- Modernizr JS -->
	<script th:src="@{../js/modernizr-2.6.2.min.js}"></script>
	<!-- FOR IE9 below -->
	<!--[if lt IE 9]>
	<script th:src="@{../js/respond.min.js}"></script>
	<![endif]-->

        <!-- jQuery -->
        <script th:src="@{../js/jquery.min.js}"></script>
        <!-- jQuery Easing -->
        <script th:src="@{../js/jquery.easing.1.3.js}"></script>
        <!-- Bootstrap -->
        <script th:src="@{../js/bootstrap.min.js}"></script>
        <!-- Waypoints -->
        <script th:src="@{../js/jquery.waypoints.min.js}"></script>
        <!-- Stellar Parallax -->
        <script th:src="@{../js/jquery.stellar.min.js}"></script>
        <!-- Easy PieChart -->
        <script th:src="@{../js/jquery.easypiechart.min.js}"></script>

        <!-- Main -->
        <script th:src="@{../js/main.js}"></script>
	</head>
	<body>
	<!--个人信息-->
	<div id="page">	
	<header id="fh5co-header" class="fh5co-cover js-fullheight" role="banner" style="background-image:url(../images/cover_bg_3.jpg);" data-stellar-background-ratio="0.5">
		<div class="overlay"></div>
		<div class="container">
			<div class="row">
				<div class="col-md-8 col-md-offset-2 text-center">
					<div class="display-t js-fullheight">
						<div class="display-tc js-fullheight animate-box" data-animate-effect="fadeIn">
							<div onclick="" class="profile-thumb" style="background: url(../images/user-3.jpg)"></div>
							<!--用户名-->
							<h1><span th:text="${session.user.getName()}">User Name</span></h1>
							<h3><span id="detail" th:text="${session.user.getJob()}">Job / Location</span> / <span th:text="${session.user.getLocation()}"></span></h3>
							<input id="user_id" type="hidden" th:value="${session.user.getUser_id()}">
							<p>
								<ul class="fh5co-social-icons">
									<li><a href="#"><i class="icon-qq"></i></a></li>
									<li><a href="#"><i class="icon-mobile3"></i></a></li>
									<li><a href="#"><i class="icon-chat"></i></a></li>
									<li><a href="#"><i class="icon-location3"></i></a></li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</header>

	<!--添加账单-->
	<div id="fh5co-consult">
		<div class="video fh5co-video" style="background-image: url(../images/cover_bg_1.jpg)">
			<div class="overlay"></div>
		</div>
		<div class="choose animate-box">
			<h2>New Bill</h2>
			<form action="" id="form">
				<div class="row form-group">
					<div class="col-md-6">
						<input name='cost' type="number" id="cost" class="form-control" placeholder="Total Cost">
					</div>
				</div>
				<div class="row form-group">
					<div class="col-md-6">
						<input name="date" type="date" id="date" class="form-control" placeholder="Date">
					</div>
				</div>
				<div class="row form-group">
					<div class="col-md-12">
						<select id="types" class="form-control">

						</select>
					</div>
				</div>
				<div class="row form-group">
					<div class="col-md-12">
						<textarea name="note" id="note" cols="30" rows="10" class="form-control" placeholder="Take Some Note For This Bill"></textarea>
					</div>
				</div>
				<div class="form-group">
					<button id="addBill"  class="btn btn-primary">Add New Bill</button>
				</div>

                <div class="form-group">
                    <button id="modifySelf"  class="btn btn-primary" data-toggle="modal" data-target="#myModal">Modify Self Info</button>
                </div>

			</form>
		</div>
	</div>

        <!-- 模态框（Modal） -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">Modify Self Information</h4>
                    </div>
                    <div class="modal-body">
                        <!--中间主要内容-->

                            <div class="row form-group">
                                <div class="col-md-6">
                                    <input th:value="${session.user.getUser_id()}" name='userId' id="userId" type="hidden"  class="form-control" placeholder="userId">
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-md-6">
                                    <input th:value="${session.user.getUser_name()}" name='username' type="hidden" id="username" class="form-control" placeholder="username">
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-md-6">
                                    PassWord: <input th:value="${session.user.getPasswd()}" name='password' type="password" id="password" class="form-control" placeholder="password">
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-md-6">
                                    Name: <input th:value="${session.user.getName()}" name='name' type="text" id="name" class="form-control" placeholder="name">
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-md-6">
                                    Job: <input th:value="${session.user.getJob()}" name='job' type="text" id="job" class="form-control" placeholder="job">
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-md-6">
                                    Location: <input th:value="${session.user.getLocation()}" name='location' type="text" id="location" class="form-control" placeholder="location">
                                </div>
                            </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button id="modify" class="btn btn-primary">Modify</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>

	<!--详细账单图-->
	<div id="fh5co-resume" class="fh5co-bg-color">
		<div class="container">
			<div class="row animate-box">
				<div class="col-md-8 col-md-offset-2 text-center fh5co-heading">
					<h2>My Bills</h2>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12 col-md-offset-0">
					<ul id="time_line" class="timeline">

			    	</ul>
				</div>
			</div>
		</div>
	</div>
	


	<!--支出类别百分比图-->
	<div id="fh5co-skills" class="animate-box">
		<div class="container">
			<div class="row">
				<div class="col-md-8 col-md-offset-2 text-center fh5co-heading">
					<h2>Percentage Of The Types</h2>
				</div>
			</div>
			<!--圈-->
			<div id="percentage_circle" class="row row-pb-md">

			</div>

			<!--条-->
			<div id="percentage_bar" class="row">

			</div>
		</div>
	</div>
	</div>


	<div class="gototop js-top">
		<a href="#" class="js-gotop"><i class="icon-arrow-up22"></i></a>
	</div>



	</body>


    <script>

		$("#form").submit(function () {
			return false;
		});
		$("#self_form").submit(function () {
			return false;
		});
		$("#modify").click(function () {
			// alert($("#self_form").serialize());
			$.ajax({
				type: "POST",
				url: "/user/modifySelf",
				data: {
					"userId": $("#userId").val(),
					"username": $("#username").val(),
					"password": $("#password").val(),
					"name": $("#name").val(),
					"job": $("#job").val(),
					"location": $("#location").val()
				},
				async: false,
				success:function (result) {
					if (result){
						$("#myModal").modal("hide");
						var username = $("#username").val();
						var passwd = $("#password").val();
						window.location.href="/user/checkInfo?username="+username+"&password="+passwd;
					} else {
						alert("修改失败！");
					}
				}
			});
		});
		$("#addBill").click(function () {
			$.ajax({
				type:"POST",
				url:"/bill/addNewBill",
				data:{"user_id": $("#user_id").val(), "cost_type": $("#types").find("option:selected").val(),
					"cost": $("#cost").val(), "cost_date": $("#date").val(), "note": $("#note").val()},
				async:false,
				success:function (result) {
					if (result){
						alert("添加成功!");
						refresh();
					}else {
						alert("添加失败!");
					}
				}
			})
		});
		function myTime(date){
			var arr=date.split("T");
			var d=arr[0];
			var darr = d.split('-');

			var t=arr[1];
			var tarr = t.split('.000');
			var marr = tarr[0].split(':');

			var dd = parseInt(darr[0])+"/"+parseInt(darr[1])+"/"+parseInt(darr[2])+" "+parseInt(marr[0])+":"+parseInt(marr[1])+":"+parseInt(marr[2]);
			return dd;
		}

		// 数字补0操作
		function addZero(num) {
			return num < 10 ? '0' + num : num;
		}

		function formatDateTime (date) {
			var time = new Date(Date.parse(date));
			time.setTime(time.setHours(time.getHours() + 8));
			var Y = time.getFullYear() + '-';
			var  M = this.addZero(time.getMonth() + 1) + '-';
			var D = this.addZero(time.getDate()) + ' ';
			var h = this.addZero(time.getHours()) + ':';
			var m = this.addZero(time.getMinutes()) + ':';
			var  s = this.addZero(time.getSeconds());
			return Y + M + D;
			// }
		}



		function refresh() {
			var type_lsit;
			$.ajax({
				type:"POST",
				url:"/type/allTypes",
				success:function (data) {
					type_lsit = data;
					var html="";
					$.each(data, function (index, type) {
						html += '<option name="type" value="'+type.type_id+'">'+type.type_name+'</option>';
					});
					$("#types").html(html);
				}
			});


				var html = '<li class="timeline-heading text-center"><div><h3>FROM NOW</h3></div></li>';
				$.ajax({
					type: "POST",
					url: "/bill/allBills",
					data: {"user_id": $("#user_id").val()},
					success: function (bills) {
						$.each(bills, function (index, bill) {
							var date = formatDateTime(myTime(bill.cost_date));
							// alert(date);
							// alert(typeof date);
							// alert(index);

							var cost = bill.cost;
							var type_;
							$.each(type_lsit, function (i, type) {
								if (type.type_id === bill.cost_type){
									type_ = type.type_name;
								}
							});

							var note = bill.note;
							var cost_str = bill.cost_type === -1?"Save + ￥":"Cost - ￥";
							if (index % 2 === 0) {
								html += '<li class="timeline-unverted">' +
										'<div class="timeline-badge"><i class="icon-book-open"></i></div>' +
										'<div id="modify_bill" class="timeline-panel" onclick="">' +
										'<div class="timeline-heading">' +
										'<h3 class="timeline-title">'+ cost_str +cost+'</h3>' +
										'<span class="company">'+type_ + ' - ' + date + '</span>' +
										'</div>' +
										'<div class="timeline-body">' +
										'<p>Note -  '+ note +'</p>' +
										'</div>' +
										'</div>' +
										'</li>';
							}else {
								html += '<li class="timeline-inverted">' +
										'<div class="timeline-badge"><i class="icon-book-open"></i></div>' +
										'<div id="modify_bill" class="timeline-panel">' +
										'<div class="timeline-heading">' +
										'<h3 class="timeline-title">'+ cost_str +cost+'</h3>' +
										'<span class="company">'+type_ + ' - ' + date + '</span>' +
										'</div>' +
										'<div class="timeline-body">' +
										'<p>Note - '+ note +'</p>' +
										'</div>' +
										'</div>' +
										'</li>';
							}
							$("#time_line").html(html);

						})
					}
				});

			$.ajax({
				type: "POST",
				url: "/bill/billTypePercentage",
				data: {"user_id": $("#user_id").val()},
				success:function (data) {
					var html = "";
					var html_ = "<div class=\"col-md-6\">";
					$.each(data, function (index, obj) {
						// alert(index);
						html += '<div class="col-md-3 col-sm-6 col-xs-12 text-center">\n' +
								'<div class="chart" data-percent="'+ obj.percentage +'"><span><strong>'+obj.type_name+'</strong>'+obj.percentage+'%</span></div>' +
								'</div>';
						var len = data.length;
						var mid = len / 2;
						// alert(len);
						// alert(mid);
						if (index < mid){
							var rand = 1+Math.round(Math.random()*(5-1));
							// alert(rand);
							html_ += '<div class="progress-wrap">' +
									'<h3><span class="name-left">'+ obj.type_name+'</span><span class="value-right">'+obj.percentage+'%</span></h3>' +
									'<div class="progress">' +
									'<div class="progress-bar progress-bar-'+rand+' progress-bar-striped active" role="progressbar"' +
									'aria-valuenow="'+obj.percentage+'" aria-valuemin="0" aria-valuemax="100" style="width:'+obj.percentage+'%">' +
									'</div>' +
									'</div>' +
									'</div>';
						}else if (index === mid){
							html_ += '</div>' +
									'<div class="col-md-6">' +
									'<div class="progress-wrap">'+
									'<h3><span class="name-left">'+ obj.type_name+'</span><span class="value-right">'+obj.percentage+'%</span></h3>' +
									'<div class="progress">' +
									'<div class="progress-bar progress-bar-'+rand+' progress-bar-striped active" role="progressbar"' +
									'aria-valuenow="'+obj.percentage+'" aria-valuemin="0" aria-valuemax="100" style="width:'+obj.percentage+'%">' +
									'</div>' +
									'</div>' +
									'</div>';
						} else {
							html_ += '<div class="progress-wrap">' +
									'<h3><span class="name-left">'+ obj.type_name+'</span><span class="value-right">'+obj.percentage+'%</span></h3>' +
									'<div class="progress">' +
									'<div class="progress-bar progress-bar-'+rand+' progress-bar-striped active" role="progressbar"' +
									'aria-valuenow="'+obj.percentage+'" aria-valuemin="0" aria-valuemax="100" style="width:'+obj.percentage+'%">' +
									'</div>' +
									'</div>' +
									'</div>';
						}
					});
					html_ += '</div>';
					$("#percentage_circle").html(html);
					$("#percentage_bar").html(html_);
				}
			})
		}
		$(document).ready(refresh());
    </script>
</html>

